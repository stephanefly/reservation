{% extends 'app/team/index.html' %}
{% block content %}

<style>
    .acompte-ok {
        background: #28a745 !important;
        color: white;
        font-weight: bold;
        border-radius: 10px;
    }

    .presta-fini {
        background: #005315 !important;
        color: white;
        font-weight: bold;
        border-radius: 10px;
    }
    .post-presta {
        background: #8a507d !important;
        color: white;
        font-weight: bold;
        border-radius: 10px;
    }

    .calendar-container {
        width: auto;
        margin: auto;
        background: white;
        color: black;
        padding: 10px;
        margin: 0px 15px;
        border-radius: 12px;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 24px;
        font-weight: bold;
        padding: 15px;
        background: #007bff;
        color: white;
        border-radius: 10px;
    }

    .calendar-header button {
        padding: 10px;
        border: none;
        background-color: white;
        color: #007bff;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 5px;
        transition: 0.3s;
    }

    .calendar-header button:hover {
        background-color: #0056b3;
        color: white;
    }

    .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        margin-top: 10px;
        text-align: center;
    }

    .day-name {
        font-weight: bold;
        padding: 10px 0px;
        background: #77b1ff;
        color: white;
        border: 1px solid #ddd;
    }

    .day {
        border: 1px solid #ddd;
        font-size: 18px;
        min-height: 80px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: 0.3s;
        cursor: pointer;
        border-radius: 8px;
    }

    .day:hover {
        background: #f4f4f4;
    }

    .today {
        background: linear-gradient(135deg, #ffcc00, #ff8800);
        color: black;
        font-weight: bold;
        border-radius: 10px;
        border-color: #ffc800;
        border-width: thick;
    }

    .selected {
        color: #655700 !important;
        font-weight: bold;
        border-radius: 10px;
        border-width: thick;
    }

    @media (max-width: 768px) {
        .day {
            font-size: 14px;
        }

        .calendar-header {
            font-size: 20px;
        }
    }

    /* Zone détails sous le calendrier */
    #eventDetails {
        width: 95%;
        margin: 20px auto;
    }

    /* Layout des blocs événements / machines / options */
    .day-details {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    /* Deux colonnes sur écran large */
    @media (min-width: 992px) {
        .day-details {
            flex-direction: row;
            align-items: flex-start;
        }
        .day-col {
            flex: 1;
        }
    }

    /* Cartes/panneaux */
    .panel {
        background: #ffffff;
        border-radius: 10px;
        padding: 12px 14px;
        border: 1px solid #ddd;
        box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }

    .panel h3,
    .panel h4 {
        margin: 0 0 10px;
        font-size: 18px;
        font-weight: 600;
    }

    /* Code couleur cohérent */
    .events-panel {
        border-left: 4px solid #28a645;
    }

    .machines-panel {
        border-left: 4px solid #4040ff;
    }

    .options-panel {
        border-left: 4px solid #86cdea;
    }

    /* TABLEAUX GÉNÉRAUX */
    .events-table,
    .machines-table,
    .options-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .events-table thead tr,
    .machines-table thead tr,
    .options-table thead tr {
        background: #f5f5f5;
    }

    .events-table th,
    .events-table td,
    .machines-table th,
    .machines-table td,
    .options-table th,
    .options-table td {
        border: 1px solid #ddd;
        padding: 6px 8px;
        text-align: left;
    }

    /* Lignes alternées */
    .events-table tbody tr:nth-child(odd),
    .machines-table tbody tr:nth-child(odd),
    .options-table tbody tr:nth-child(odd) {
        background: #fafafa;
    }

    /* Hover léger */
    .events-table tbody tr:hover,
    .machines-table tbody tr:hover,
    .options-table tbody tr:hover {
        background: #eef3ff;
    }

    /* Couleurs de header spécifiques */
    .machines-table thead tr {
        background: #d1d4ff;
    }

    .options-table thead tr {
        background: #e5f7ff;
    }

    /* Colonne client mise en valeur */
    .events-table td:first-child {
        font-weight: 600;
        color: #0056b3;
    }

    /* Badges de dispo si besoin */
    .badge-dispo {
        display: inline-block;
        min-width: 40px;
        padding: 2px 10px;
        border-radius: 999px;
        font-size: 0.8rem;
        font-weight: 600;
        text-align: center;
    }
    .badge-dispo-zero {
        background: #dcfce7;
        color: #166534;
    }
    .badge-dispo-low {
        background: #fef9c3;
        color: #854d0e;
    }
    .badge-dispo-ok {
        background: #fee2e2;
        color: #b91c1c;
    }
</style>

<div class="calendar-container">
    <div class="calendar-header">
        <button onclick="prevMonth()">◀</button>
        <span id="monthYear"></span>
        <button onclick="nextMonth()">▶</button>
    </div>
    <div class="calendar-days">
        <!-- Jours de la semaine -->
        <div class="day-name">Lun</div>
        <div class="day-name">Mar</div>
        <div class="day-name">Mer</div>
        <div class="day-name">Jeu</div>
        <div class="day-name">Ven</div>
        <div class="day-name">Sam</div>
        <div class="day-name">Dim</div>
    </div>
    <div class="calendar-days" id="calendarDays"></div>
</div>

<hr>

<div id="eventDetails"></div>

<!-- 1) Variables globales + données Django -->
<script>
    let currentDate = new Date();
    let selectedDay = null;

    const events_ok = {{ events_ok_data|safe }};
    const events_presta_fini = {{ events_presta_fini_data|safe }};
    const events_post_presta = {{ events_post_presta_data|safe }};
    const calendarData = {{ calendar_data|safe }};
</script>

<!-- 2) Rendu du calendrier + navigation -->
<script>
    function renderCalendar() {
        const monthYear = document.getElementById("monthYear");
        const daysContainer = document.getElementById("calendarDays");
        daysContainer.innerHTML = "";

        const month = currentDate.getMonth();
        const year = currentDate.getFullYear();
        monthYear.textContent = new Intl.DateTimeFormat('fr-FR', { month: 'long', year: 'numeric' }).format(currentDate);

        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;

        for (let i = 0; i < adjustedFirstDay; i++) {
            const emptyDiv = document.createElement("div");
            emptyDiv.classList.add("day", "empty");
            daysContainer.appendChild(emptyDiv);
        }

        for (let day = 1; day <= lastDate; day++) {
            const dayDiv = document.createElement("div");
            dayDiv.classList.add("day");
            dayDiv.textContent = day;

            const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;

            if (events_ok.some(event => event.date === dateStr)) {
                dayDiv.classList.add("acompte-ok");
            } else if (events_presta_fini.some(event => event.date === dateStr)) {
                dayDiv.classList.add("presta-fini");
            } else if (events_post_presta.some(event => event.date === dateStr)) {
                dayDiv.classList.add("post-presta");
            }

            dayDiv.addEventListener("click", () => selectDay(dayDiv, dateStr));
            daysContainer.appendChild(dayDiv);
        }
    }

    function prevMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    }

    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    }

    document.addEventListener("DOMContentLoaded", renderCalendar);
</script>

<!-- 3) Sélection d’un jour + affichage des données calculées en Python -->
<script>
    function selectDay(dayDiv, date) {
        if (selectedDay) {
            selectedDay.classList.remove("selected");
        }
        selectedDay = dayDiv;
        selectedDay.classList.add("selected");
        showEvents(date);
    }

    function showEvents(date) {
        const eventDetails = document.getElementById("eventDetails");
        const data = calendarData[date];

        if (!data) {
            eventDetails.innerHTML = `
                <div class="panel">
                    <h3>${date}</h3>
                    <p>Aucun événement ce jour-là.</p>
                </div>
            `;
            return;
        }

        // Tableau événements
        const eventsRows = data.events.map(e => `
            <tr>
                <td>${e.title}</td>
                <td>${e.ville}</td>
                <td>${e.code_postal}</td>
            </tr>
            <tr>
                <td colspan="3" style="
                    font-size:0.85rem;
                    background:#f9fafb;
                    padding: 6px 8px;
                    border-bottom: 3px solid #777777;
                ">
                    <!-- Produit : toujours affiché -->
                    <span style="
                        display:inline-block;
                        background:#4040ff;
                        color:white;
                        padding:3px 10px;
                        border-radius:6px;
                        font-weight:600;
                        margin-right:8px;
                    ">
                        ${e.product}
                    </span>

                    <!-- Options : affichées uniquement si présentes -->
                    ${e.options ? `
                        <span style="
                            display:inline-block;
                            background:#86cdea;
                            color:#003049;
                            padding:3px 10px;
                            border-radius:6px;
                            font-weight:600;
                        ">
                            ${e.options}
                        </span>
                    ` : ""}
                </td>

            </tr>
        `).join("");

        const eventsTable = `
            <h3>Événements du ${date}</h3>
            <table class="events-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Ville</th>
                        <th>CP</th>
                    </tr>
                </thead>
                <tbody>
                    ${eventsRows}
                </tbody>
            </table>
        `;

        // Tableau machines
        const machinesRows = Object.entries(data.machines_available).map(([machine, dispo]) => {
            const used = data.machines_used[machine] || 0;

            let badgeClass = "badge-dispo-low";
            if (dispo <= 0) {
                badgeClass = "badge-dispo-zero";
            } else if (dispo === (data.machines_used[machine] + dispo)) {
                badgeClass = "badge-dispo-ok";
            }

            return `
                <tr>
                    <td>${machine}</td>
                    <td>${used}</td>
                    <td><span class="badge-dispo ${badgeClass}">${dispo}</span></td>
                </tr>
            `;
        }).join("");

        const machinesTable = `
            <h4>Machines disponibles ce jour</h4>
            <table class="machines-table">
                <thead>
                    <tr>
                        <th>Machine</th>
                        <th>Réservées</th>
                        <th>Disponibles</th>
                    </tr>
                </thead>
                <tbody>
                    ${machinesRows}
                </tbody>
            </table>
        `;

        // Tableau options
        const optionsRows = Object.entries(data.options_available).map(([opt, dispo]) => {
            const used = data.options_used[opt] || 0;

            let badgeClass = "badge-dispo-low";
            if (dispo <= 0) {
                badgeClass = "badge-dispo-zero";
            } else if (dispo === (data.options_used[opt] + dispo)) {
                badgeClass = "badge-dispo-ok";
            }

            return `
                <tr>
                    <td>${opt}</td>
                    <td>${used}</td>
                    <td><span class="badge-dispo ${badgeClass}">${dispo}</span></td>
                </tr>
            `;
        }).join("");

        const optionsTable = `
            <h4>Options disponibles ce jour</h4>
            <table class="options-table">
                <thead>
                    <tr>
                        <th>Option</th>
                        <th>Réservées</th>
                        <th>Disponibles</th>
                    </tr>
                </thead>
                <tbody>
                    ${optionsRows}
                </tbody>
            </table>
        `;

        eventDetails.innerHTML = `
            <div class="day-details">
                <div class="day-col panel events-panel">
                    ${eventsTable}
                </div>
                <div class="day-col">
                    <div class="panel machines-panel">
                        ${machinesTable}
                    </div>
                    <div class="panel options-panel" style="margin-top:12px;">
                        ${optionsTable}
                    </div>
                </div>
            </div>
        `;
    }
</script>

{% endblock %}
