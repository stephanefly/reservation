{% extends 'app/backend/base.html' %}
{% block content %}
<style>
    .highlight-prestation {
        background-color: blue;
        color: white;
        padding: 0 3px;
    }

    .highlight-option {
        background-color: skyblue;
        color: black;
        padding: 0 3px;
    }

    .highlight-membre {
        background-color: #f1cd9d;
        color: black;
        padding: 0 3px;
    }

    .card {
        border: solid 0.5px;
    }
</style>

<div class="container">

    <table id="table" class="table table-bordered table-striped" style="background-color:white">
        <thead>
        <tr>
            <th>NOM</th>
            <th>DATE-EVENT</th>
            <th>Membre</th>
            <th>Presta Payé</th>
            <th>Membre Payé</th>
            <th>Feedback</th>
            <th>Feedback Posté</th>
            <th>Envoi</th>
        </tr>
        </thead>
        <tbody>
        {% for event in lst_post_event %}
        <tr>
            <td><a href="info-event/{{ event.id }}">{{ event.client.nom }}</a></td>
            <td>{{ event.event_details.date_evenement|date:"Y-m-d" }}</td>
            <td>Membre</td>
            <td class="{% if event.post_presta.paid %}bg-success{% else %}bg-danger{% endif %}">
                {% if not event.post_presta.paid %}Pas OK{% else %}Fait{% endif %}
            </td>
            <td class="{% if event.post_presta.membre_paid %}bg-success{% else %}bg-info{% endif %}">
                {% if not event.post_presta.membre_paid %}Pas OK{% else %}Fait{% endif %}
            </td>
            <td class="{% if event.post_presta.feedback %}bg-success{% else %}bg-warning{% endif %}">
                {% if not event.post_presta.feedback %}Pas OK{% else %}Fait{% endif %}
            </td>
            <td class="{% if event.post_presta.feedback_posted %}bg-success{% else %}bg-warning{% endif %}">
                {% if not event.post_presta.feedback_posted %}Pas OK{% else %}Fait{% endif %}
            </td>
            <td class="{% if event.post_presta.sent %}bg-success{% else %}bg-danger{% endif %}">
                {% if not event.post_presta.sent %}Pas OK{% else %}Fait{% endif %}
            </td>
        </tr>

        {% endfor %}
        </tbody>
    </table>

    {% for event in lst_post_event %}
    <div class="card">
        <div class="card-header">
            <h5>
                <a href="{% url 'info_event' event.id %}" class="btn btn-link">{{ event.client.nom }}</a>
            </h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered table-striped" style="background-color:white">
                <thead>
                <tr>
                    <th>Mail</th>
                    <th>Date-Event</th>
                    <th>Membre</th>
                    <th>PC</th>
                    <th>PRIX</th>
                    <th>Acompte</th>
                    <th>Restant</th>
                    <th>Mode</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>{{ event.client.mail }}</td>
                    <td>{{ event.event_details.date_evenement|date:"Y-m-d" }}</td>
                    <td>Membre</td>
                    <td>PC</td>
                    <td id="prix_valided">{{ event.prix_valided }}</td>
                    <td id="montant_acompte">{{ event.event_acompte.montant_acompte }}</td>
                    <td id="difference">{{ event.event_acompte.montant_restant }}</td>
                    <td id="mode_payement">{{ event.event_acompte.mode_payement }}</td>
                </tr>
                </tbody>
            </table>
            <table class="table table-bordered table-striped" style="background-color:white">
                <thead>
                <tr>
                    <th>Payé</th>
                    <th>Membre Payé</th>
                    <th>Feedback</th>
                    <th>Feedback Posté</th>
                    <th>Envoi</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>
                        {% if not event.post_presta.paid %}
                        {% csrf_token %}
                        <button class="ajax-btn" data-id="{{ event.post_presta.id }}" data-action="paid">OK</button>
                        {% else %}
                        Fait
                        {% endif %}
                    </td>
                    <td>
                        {% if not event.post_presta.membre_paid %}
                        {% csrf_token %}
                        <button class="ajax-btn" data-id="{{ event.post_presta.id }}" data-action="membre_paid">OK
                        </button>
                        {% else %}
                        Fait
                        {% endif %}
                    </td>
                    <td>
                        {% if not event.post_presta.feedback %}
                        {% csrf_token %}
                        <button class="ajax-btn" data-id="{{ event.post_presta.id }}" data-action="feedback">OK</button>
                        {% csrf_token %}
                        <button class="ajax-btn" data-id="{{ event.id }}" data-action="relance_avis">Relance avis
                            client
                        </button>
                        {% else %}
                        Fait
                        {% endif %}
                    </td>
                    <td>
                        {% if not event.post_presta.feedback_posted %}
                        {% csrf_token %}
                        <button class="ajax-btn" data-id="{{ event.post_presta.id }}" data-action="feedback_posted">OK
                        </button>
                        {% else %}
                        Fait
                        {% endif %}
                    </td>
                    <td>
                        {% if not event.post_presta.sent %}
                        {% csrf_token %}
                        <button class="ajax-btn" data-id="{{ event.post_presta.id }}" data-action="sent">OK</button>
                        {% else %}
                        Fait
                        {% endif %}
                    </td>
                    <td>
                        <form method="POST" action="{% url 'presta_fini' event.id %}">
                            {% csrf_token %}
                            <button type="submit">
                                Finir Presta
                            </button>
                        </form>
                    </td>
                </tr>

                </tbody>
            </table>
        </div>
    </div>
    <br>
    {% endfor %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM chargé, script actif');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        document.querySelectorAll('.ajax-btn').forEach(button => {
            console.log('Bouton trouvé:', button);
            button.addEventListener('click', function () {
                console.log('Bouton cliqué:', this.dataset.id, this.dataset.action);

                const id = this.dataset.id;
                const action = this.dataset.action;

                // Génération de la partie statique de l'URL en utilisant Django, sans les paramètres
                const url = `{% url 'update_post_presta_status' 0 'placeholder' %}`.replace('0', id).replace('placeholder', action);

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                })
                    .then(response => {
                        console.log('Réponse reçue:', response);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Données reçues:', data);
                        if (data.success) {
                            this.outerHTML = `<span>${data.action === 'relance_avis' ? 'Relancé' : 'Fait'}</span>`;
                        } else {
                            alert('Erreur: ' + data.message);
                        }
                    })
                    .catch(error => console.error('Erreur:', error));
            });
        });
    });
</script>

{% endblock %}
