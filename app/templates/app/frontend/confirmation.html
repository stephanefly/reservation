{% extends 'app/frontend/index.html' %}
{% block content %}
<style>
/* Overlay plein écran */
#overlay-loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(4px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

/* Spinner centré dans le bouton */
.btn-spinner {
    border: 3px solid rgba(255, 255, 255, 0.4);
    border-top: 3px solid #5a4300;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    animation: spin 0.7s linear infinite;
    margin-right: 8px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Animation "Chargement..." */
.loading-dots::after {
    content: '';
    animation: dots 1.5s infinite steps(4, end);
}

@keyframes dots {
    0%   { content: ''; }
    25%  { content: '.'; }
    50%  { content: '..'; }
    75%  { content: '...'; }
    100% { content: ''; }
}
</style>

<div id="overlay-loading">
    <div>
        <div class="btn-spinner" style="margin: 0 auto;"></div>
        <p style="text-align:center; font-size:18px; margin-top:10px;">Traitement en cours…</p>
    </div>
</div>

<div class="card">
    <div class="card-header bg-primary text-white" style="background-image: linear-gradient(to bottom, #ffef96, #5a4300)">
        <h2 class="text-center">Confirmez vos informations</h2>
    </div>
    <div class="card-body">
        <form method="post" action="{% url 'confirmation' %}">
            {% csrf_token %}


            {% if form_data.type == 'personne' %}
            <div class="form-group">
                <strong><label for="nom">Nom:</label></strong>
                <p>{{ form_data.nom }}</p>
                <input type="hidden" name="nom" value="{{ form_data.nom }}">
            </div>
            <div class="form-group">
                <strong><label for="prenom">Prénom:</label></strong>
                <p>{{ form_data.prenom }}</p>
                <input type="hidden" name="prenom" value="{{ form_data.prenom }}">
            </div>
            {% else %}
            <div class="form-group">
                <strong><label for="raison_sociale">Raison Sociale:</label></strong>
                <p>{{ form_data.raison_sociale }}</p>
                <input type="hidden" name="raison_sociale" value="{{ form_data.raison_sociale }}">
            </div>
            {% endif %}


            <div class="form-group">
                <strong><label for="mail">Mail:</label></strong>
                <p>{{ form_data.mail }}</p>
                <input type="hidden" name="mail" value="{{ form_data.mail }}">
            </div>
            <div class="form-group">
                <strong><label for="numero_telephone">Numéro de téléphone:</label></strong>
                <p>{{ form_data.numero_telephone }}</p>
                <input type="hidden" name="numero_telephone" value="{{ form_data.numero_telephone }}">
            </div>
            <div class="form-group">
                <strong><label for="date_evenement">Date de l'événement:</label></strong>
                <p>{{ form_data.date_evenement }}</p>
                <input type="hidden" name="date_evenement" value="{{ form_data.date_evenement }}">
            </div>
            <div class="form-group">
                <strong><label for="adresse_evenement">Adresse de l'événement:</label></strong>
                <p>{{ form_data.adresse_evenement }}</p>
                <input type="hidden" name="adresse_evenement" value="{{ form_data.adresse_evenement }}">
            </div>
            <div class="form-group">
                <strong><label for="ville_evenement">Ville de l'événement:</label></strong>
                <p>{{ form_data.ville_evenement }}</p>
                <input type="hidden" name="ville_evenement" value="{{ form_data.ville_evenement }}">
            </div>
            <div class="form-group">
                <strong><label for="code_postal_evenement">Code Postal de l'événement:</label></strong>
                <p>{{ form_data.code_postal_evenement }}</p>
                <input type="hidden" name="code_postal_evenement" value="{{ form_data.code_postal_evenement }}">
            </div>
            <!-- Si le champ client_how_find est censé être visible, retirez style="display:none;" et ajustez en conséquence -->
            <div class="form-group" style="display:none;">
                <strong><label for="client_how_find">Comment avez-vous trouvé ? :</label></strong>
                <p>{{ form_data.client_how_find }}</p>
                <input type="hidden" name="client_how_find" value="{{ form_data.client_how_find }}">
            </div>
            <div class="form-group">
                <strong><label for="selectedImages">Produit(s) sélectionné(s):</label></strong>
                <p>{{ form_data.selectedImages }}</p>
                <input type="hidden" name="selectedImages" value="{{ form_data.selectedImages }}">
            </div>
            <div class="form-group">
                <strong><label for="personnalisation_modele">Personnalisation Modèle:</label></strong>
                <p>Oui</p>
            </div>
            <div class="form-group">
                <strong><label for="galerie_photos_videos">Galerie Photos/Videos:</label></strong>
                <p>Oui</p>
            </div>
            <div class="form-group">
                <strong><label for="selectedOption">Option(s) sélectionnée(s):</label></strong>
                <p>{{ form_data.selectedOption}}</p>
                <input type="hidden" name="selectedOption" value="{{ form_data.selectedOption }}">
            </div>
            <div class="form-group">
                <strong><label for="magnets_range">Magnets Photos:</label></strong>
                <p>{{ form_data.magnets_range }}</p>
                <input type="hidden" name="magnets_range" value="{{ form_data.magnets_range }}">
            </div>
            <div class="form-group">
                <strong><label for="livraison">Livraison - Installation - Animateur:</label></strong>
                <p>
                    {% if form_data.heure_range %}
                        Oui
                    {% else %}
                        Non
                    {% endif %}</p>
                <input type="hidden" name="livraison" value="{{ form_data.livraison }}">
            </div>
            <div class="form-group">
                <strong><label for="heure_range">Heures:</label></strong>
                    <p>
                        {% if form_data.heure_range %}
                            {{ form_data.heure_range }} h
                        {% else %}
                            Toute la soirée !
                        {% endif %}
                    </p>
                <input type="hidden" name="heure_range" value="{{ form_data.heure_range }}">
            </div>
            <div class="text-center">
<button
    type="submit"
    id="btn-confirm"
    class="btn btn-success"
    style="background-image: linear-gradient(to bottom, #ffef96, #5a4300); border: 1px solid goldenrod; display:flex; align-items:center; justify-content:center; gap:8px; width:200px;"
>
    <div id="spinner" class="btn-spinner" style="display:none;"></div>
    <span id="btn-text">Confirmer</span>
</button>

                <a href="{% url 'demande_devis' %}" class="btn btn-secondary">Modifier</a>
            </div>
        </form>
    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.querySelector("form");
  const btn  = document.getElementById("btn-confirm");
  const txt  = document.getElementById("btn-text");
  const spn  = document.getElementById("spinner");
  const overlay = document.getElementById("overlay-loading");

  form.addEventListener("submit", function (e) {
    // Affiche le loader, NE BLOQUE PAS la soumission (pas de preventDefault ici)
    btn.disabled = true;
    spn.style.display = "inline-block";
    txt.textContent = "Envoi de la demande de devis";
    btn.style.opacity = "0.7";
    btn.style.cursor = "not-allowed";
    overlay.style.display = "flex";
  });

  // Quand on quitte la page (navigation/redirect), on masque l’overlay côté page sortante
  window.addEventListener("beforeunload", () => {
    overlay.style.display = "none";
  });

  // Watchdog : si pas de réponse sous 20s, message d’info
  setTimeout(() => {
    if (overlay.style.display === "flex") {
      const p = overlay.querySelector("p");
      if (p) p.textContent = "Toujours en cours… (le traitement peut prendre un peu de temps)";
    }
  }, 20000);
});
</script>



{% endblock %}
