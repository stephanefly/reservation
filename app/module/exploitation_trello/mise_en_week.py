
import pandas as pd
from dateutil.relativedelta import relativedelta

def new_mise_en_week(df_all):

    # Nettoyage initial et remplacement des valeurs vides par 0
    df_all['Ponderation'] = df_all[['Photobooth', 'Miroirbooth', '360Booth']].fillna(0).sum(axis=1).astype(int)

    # Calcul des prix proportionnels pour chaque produit
    lst_produit = ['Photobooth', 'Miroirbooth', '360Booth']
    for produit in lst_produit:
        prix_colonne = f'Prix{produit}'
        for i in range(1, 4):
            df_all.loc[df_all['Ponderation'] == i, prix_colonne] = df_all['Prix'] / i * df_all[produit]

    # Conversion de la date en format datetime et tri par date
    df_all['Date-Event'] = pd.to_datetime(df_all['Date-Event'], format='%Y-%m-%d')
    df_all = df_all.sort_values(by='Date-Event')

    # Groupement des données par semaine pour les différents calculs
    agg_funcs = {'Prix': 'sum', 'PrixPhotobooth': 'sum', 'PrixMiroirbooth': 'sum',
                 'Prix360Booth': 'sum', 'Photobooth': 'sum', 'Miroirbooth': 'sum', '360Booth': 'sum'}
    df_all_grouped = df_all.groupby(pd.Grouper(key='Date-Event', freq='W')).agg(agg_funcs).reset_index().sort_values('Date-Event')

    # Ajout de la date de la dernière semaine et du dernier mois
    last_date = df_all_grouped["Date-Event"].iloc[-1]
    df_all_grouped = df_all_grouped.append({'Date-Event': last_date + relativedelta(weeks=1), 'Prix': 0}, ignore_index=True)
    df_all_grouped = df_all_grouped.append({'Date-Event': last_date + relativedelta(months=3), 'Prix': 0}, ignore_index=True)

    return df_all_grouped